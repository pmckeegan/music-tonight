<!DOCTYPE html>
<html ng-app="musictonight">
    <head>
	<title>Music Tonight</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, height=device-height,  initial-scale=1.0, user-scalable=no"/>
	<meta name="description" content="Music Tonight creates playlists of artists, playing near you, tonight." />
	<link rel="shortcut icon" href="img/favicon.png" type="image/png" />
	<link rel="icon" href="img/favicon.png" type="image/png" />
	<link rel="stylesheet" type="text/css" href="bower_components/animate.css/animate.css" inline />
	<script>
	 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	 })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	 ga('create', 'GOOGLE_ANALYTICS_ID', 'auto');
	 ga('send', 'pageview');
	</script>
	
	<script src="bower_components/angularjs/angular.js" inline></script>
        <script src="bower_components/angular-animate/angular-animate.js" inline></script>
	<style>
	 /* CSS reset */
	 body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,form,fieldset,input,textarea,p,blockquote,th,td { 
	   margin:0;
	   padding:0;
	 }
	 html {
	   margin:0;
	   padding:0;
	   background: #eee url(img/bkgr.svg) no-repeat top left;
	   background-size: 100%;
	   font-size: 100%;
	   font-family: Arial, Helvetica, sans-serif;
	 }
	 form {
	   display:inline-block;
	 }
	 input {
	   display:inline-block;
	 }
	 a {
	   display:inline-block;
	 }
	 a:hover, button:hover {
	   transition: background-color 0.4s ease;
	   text-decoration: none;
	   background-color: #fff;
	 }
	 a:visited, a:link {
	   color: #000;
	   text-decoration: none;
	 }
	 .outlined {
	   color: #000000;
	   border: solid #000000 5px;
	   text-decoration: none;
	 }
	 .big {
	   font-size: 140%;
	 }
	 input.outlined {
	   padding: 0.3em 0.6em 0.3em 0.6em;
	   -webkit-border-radius: 0.2em;
	   -moz-border-radius: 0.2em;
	   border-radius: 0.2em;
	 }
	 button.outlined, a.outlined {
	   padding: 0.2em 0.4em 0.2em 0.4em;
	   -webkit-border-radius: 1em;
	   -moz-border-radius: 1em;
	   border-radius: 1em;
	   text-decoration: none;
	   opacity: 1;
	   overflow-x: hidden;
	 }
	 .bouncy.ng-hide-remove, .bouncy.ng-hide-remove {
	   -webkit-animation: bounceInRight 1s;
	   -moz-animation: bounceInRight 1s;
	   -o-animation: bounceInRight 1s;
	   animation: bounceInRight 1s;
	 }
	 .callout a {
	   text-decoration: underline;
	 }
	 .callout {
	   display: inline-block;
	   position: absolute;
	   margin-top: -1.8em;
	   margin-left: -1.0em;
	   font-style: italic;
	   font-size: 90%;
	   border: solid 1px #cccccc;
	   border-top-left-radius: 0.8em;
	   border-top-right-radius: 0.8em;
	   border-bottom-right-radius: 0.8em;
	   padding: 0.1em 0.3em;
	   background-color: #f8f8f8;
	 }
	 li.ng-enter, li.ng-move {
	   -webkit-animation: fadeIn 1s;
	   -moz-animation: fadeIn 1s;
	   -o-animation: fadeIn 1s;
	   animation: fadeIn 1s;
	 }
	 .optionlabel {
	   display: inline-block;
	   width: 12em;
	   text-align: left;
	 }
	 #options.ng-hide-remove {
	   -webkit-animation: bounceInRight 1s;
	   -moz-animation: bounceInRight 1s;
	   -o-animation: bounceInRight 1s;
	   animation: bounceInRight 1s;
	 }
	 #options.ng-hide-add {
	   -webkit-animation: bounceOutRight 1s;
	   -moz-animation: bounceOutRight 1s;
	   -o-animation: bounceOutRight 1s;
	   animation: bounceOutRight 1s;
	 }
	 .serviceicon {
	   width:1.4em;
	   height:1.2em;
	   display: inline-block;
	   position: relative;
	   margin-bottom: -0.3em;
	 }
	 #options {
	   z-index: 50;
	   background-color: #f8f8f8;
	   box-shadow: 4px 4px 4px #444;
	   border: solid #000000 0px;
	   -webkit-border-radius: 1.5em;
	   -moz-border-radius: 1.5em;
	   border-radius: 1.5em;
	   padding: 3em 0.5em;
	   position: absolute;
	   width: 85%;
	   left: 5%;
	   top: 2em;
	 }
	 ul {
	   list-style-type: none;
	   margin: 0em 1em 0em 1em;
	 }
	 li {
	   border-top: 1px solid #ddd;
	   padding: 0px;
	 }
	 li:last-child {
	   border-bottom: 1px solid #ddd;
	 }
	 .event_date {
	   font-size: 80%
	 }
	 @media (min-width: 701px) {
	   #allcontent {
	     display:block;
	     width:700px;
	     margin: 3em auto;
	   }
	 }
	 @media (max-width: 700px) {
	   #allcontent {
	     display:block;
	     margin: 4px auto;
	   }
	   #discussion {
	     clear:both;
	   }
	 }
	 .results {
	   clear:both;
	   font-size: 90%;
	   display:block;
	 }
	</style>
    </head>
    <body ng-controller="mtController">
      <div id="allcontent">
	    <div>
	      <div id="options" ng-show="showOptions" ng-cloak>
		<div style="text-align: center">
		  <div>
		    <input id="citySearchInput" type="text" class="outlined" size="27" placeholder="city/zip"/>
		  </div>
		  &nbsp;
		  <div>
		    <input ng-model="opts.daysout" type="range" min="1" max="14" step="1" />
		    <span class="optionlabel">up to {{opts.daysout}} day{{(opts.daysout>1)?'s':''}} from now</span>
		  </div>
		  &nbsp;
		  <div>
		    <input ng-model="opts.maxmiles" type="range" min="5" max="205" step="10" />
		    <span class="optionlabel">up to {{opts.maxmiles}} {{(lang=='en-US') ? 'miles' : 'km'}} away</span>
		  </div>
		  &nbsp;
		  <div>
		    <input ng-model="opts.maxartisttracks" type="range" min="1" max="5" step="1" />
		    <span class="optionlabel">up to {{opts.maxartisttracks}} tracks per artist</span>
		  </div>
		  &nbsp;
		  <div>
		    <a href="#" style="display:inline-block" class="outlined big" ng-click="$event.preventDefault(); reset_options()">reset</a>
		    <a href="#" style="display:inline-block" class="outlined big" ng-click="$event.preventDefault(); showOptions = false; save_options(); get_music()">
		      done
		      <svg xmlns="http://www.w3.org/2000/svg" version="1.1"  width="16" height="16" viewBox="0 0 128 128">
			<g data-width="128" data-height="128" class="iconic-lg iconic-container" display="inline" transform="rotate(0 64 64) translate(24)">
			  <path d="M78.8 63.1l-77.6-62.2c-.7-.5-1.2-.2-1.2.6v125c0 .8.5 1.1 1.2.6l77.7-62.1c.6-.6.6-1.4-.1-1.9z"></path>
			</g>
		      </svg>
		    </a>
		  </div>
		</div>
	      </div>


		<svg
		    xmlns="http://www.w3.org/2000/svg"
		    version="1.1"
		    width="240"
		    height="279"
		    style="float:left"
		    viewBox="0 0 269 333"
                    shape-rendering="auto">
		    <path style="fill:#000000"
			d="m 66.688084,305.51341 c -11.17582,-2.20961 -20.33598,-12.71366 -20.33598,-23.31948 0,-5.16839 3.09248,-15.71806 5.98335,-20.41162 1.10916,-1.80079 2.01665,-3.42809 2.01665,-3.61622 0,-0.18814 -2.1375,-2.00648 -4.75,-4.04077 -11.69231,-9.1045 -20.52967,-24.42278 -22.251,-38.56884 -1.64073,-13.48367 0.64132,-35.44713 5.10142,-49.09846 5.56327,-17.02785 19.09041,-37.97847 35.35784,-54.76164 9.054,-9.34105 21.78126,-20.495668 26.21866,-22.978966 1.57778,-0.882969 1.56616,-1.141827 -0.17081,-3.804182 -6.0497,-9.272741 -20.3477,-18.811281 -34.86145,-23.256919 -9.35161,-2.864448 -10.41736,-2.757189 -11.42852,1.150175 -1.68507,6.51151 -11.87727,10.054252 -16.88762,5.870023 -6.38007,-5.328112 -8.09389,-14.386157 -4.26365,-22.534639 2.61368,-5.560361 4.81581,-7.544015 9.0611,-8.162129 5.44495,-0.792784 10.93091,2.984854 13.35159,9.193915 l 1.97756,5.072461 6.90509,1.62053 c 15.95615,3.744695 34.77348,16.079853 39.82833,26.108307 1.13151,2.244843 2.18145,4.223496 2.33319,4.397008 0.151736,0.173512 2.908916,-1.000888 6.127076,-2.609778 10.77592,-5.387332 30.96488,-11.16268 39.12024,-11.190917 4.17481,-0.01445 4.25208,-0.07549 3.5,-2.764781 -0.42298,-1.5125 -0.73515,-6.575 -0.69372,-11.25 0.0866,-9.772854 2.76638,-17.426855 7.49418,-21.405034 3.26936,-2.750986 14.88956,-5.279225 16.00073,-3.481322 0.36853,0.596306 0.9591,-0.456498 1.31236,-2.339565 1.047,-5.58099 10.23274,-12.763249 16.3326,-12.770341 6.62088,-0.0077 15.24659,11.340766 13.76098,18.104703 -0.88421,4.025793 -6.45914,9.438151 -10.56812,10.259948 -2.51509,0.503017 -4.64078,0.01857 -8.75859,-1.996086 -2.99061,-1.46317 -6.1817,-3.404534 -7.09131,-4.314142 -1.44057,-1.440572 -2.51007,-1.51371 -8.2939,-0.567182 -3.67049,0.600678 -7.53564,1.897138 -8.6426,2.898925 -3.0034,2.718038 -5.13391,10.158419 -5.02198,17.538235 0.16722,11.024707 0.45531,11.467974 7.94356,12.222164 14.411,1.451427 28.08112,6.686076 36.25899,13.884532 5.56363,4.897303 14.78021,18.380417 20.1458,29.471697 l 3.87329,8.00651 5.2468,-5.12251 c 6.00442,-5.86219 13.37521,-9.86068 16.40466,-8.89917 1.68943,0.53621 2.02722,1.4987 2.02722,5.77639 0,5.35688 -8.89866,40.73224 -10.24618,40.73224 -1.24102,0 -0.8971,-2.93237 2.23845,-19.08523 3.06084,-15.76805 3.60802,-20.91476 2.22357,-20.91476 -1.58839,0 -11.21584,10.62249 -11.21584,12.37505 0,0.9967 -0.80139,2.02175 -1.78088,2.27789 -1.66227,0.43469 -1.58863,1.21102 1.1056,11.65638 2.49893,9.68821 2.95269,13.60736 3.37971,29.19067 0.43068,15.7174 0.22353,19.30545 -1.63359,28.29443 -3.12733,15.13719 -9.26985,29.73557 -15.85483,37.68074 -3.79384,4.57749 -9.92978,8.95028 -18.80072,13.39836 -7.26931,3.64498 -24.68158,10.12647 -27.20439,10.12647 -1.39845,0 -2.43787,-4.77201 -1.43122,-6.5708 0.46022,-0.82236 5.82336,-3.19954 11.9181,-5.28262 22.91045,-7.83042 31.67623,-15.65027 38.84938,-34.65708 12.31985,-32.64412 8.44316,-70.68421 -10.59438,-103.95753 -5.17573,-9.046 -12.07055,-17.498912 -17.50403,-21.459564 -5.0254,-3.663183 -16.86452,-7.701488 -25.36241,-8.651075 -5.60551,-0.626382 -6.33742,-0.518021 -5.80864,0.859981 0.33277,0.867168 0.9148,3.227864 1.2934,5.245991 0.59274,3.159574 0.44493,3.620935 -1.06397,3.321014 -0.99026,-0.196831 -2.5239,-2.305337 -3.52645,-4.848309 l -1.77411,-4.5 -7.35329,0.116926 c -8.3142,0.132206 -19.17907,2.881595 -31.85328,8.060573 -10.60624,4.333956 -11.50456,5.121 -9.88991,8.664791 1.72808,3.79271 0.21165,4.594052 -2.42831,1.28322 l -2.229716,-2.796331 -6.31739,4.650601 c -12.60112,9.276412 -28.0981,25.555092 -37.49323,39.384482 l -3.64427,5.36426 5.49681,3.31001 c 8.22244,4.95129 26.50602,20.46933 26.50602,22.49676 0,3.92465 -3.22232,2.66823 -14.15216,-5.51809 -12.14192,-9.09416 -20.29197,-13.97879 -21.78457,-13.05631 -0.56547,0.34947 -0.32634,2.67426 0.5977,5.81082 5.14402,17.46085 10.40803,28.67155 15.7312,33.50253 4.01714,3.64572 4.28035,4.42272 2.10873,6.225 -2.1094,1.75065 -6.93978,-0.38278 -9.9527,-4.39579 -3.18939,-4.24805 -8.89571,-15.94053 -11.03124,-22.60346 -0.96954,-3.025 -2.10749,-5.8775 -2.52877,-6.33889 -0.76636,-0.83932 -3.88077,7.86833 -5.84382,16.33889 -2.22411,9.59704 -3.30641,26.59475 -2.20769,34.67208 2.15675,15.85548 11.85454,29.49166 29.41112,41.35531 9.33888,6.31064 11.62375,9.27883 8.16454,10.60625 -0.81821,0.31398 -3.54373,-0.63407 -6.05671,-2.10677 -5.34114,-3.13012 -6.65214,-2.58035 -9.44057,3.95897 -3.14163,7.36758 -4.30842,14.09525 -3.08663,17.79732 1.13363,3.43491 5.88727,8.61426 9.69692,10.56532 1.99768,1.02308 2.16532,0.78718 2.79068,-3.927 0.7131,-5.37561 2.70853,-7.22549 5.15502,-4.779 1.09493,1.09493 1.19072,2.20139 0.42246,4.88014 -1.70129,5.93205 -1.48056,6.30936 3.25649,5.56667 4.76987,-0.74783 15.07331,-5.30982 18.50611,-8.19385 1.24087,-1.04249 3.29247,-4.5944 4.55913,-7.89313 1.464196,-3.81318 2.957556,-6.12375 4.100106,-6.34378 3.22661,-0.62139 3.80779,1.21884 2.49398,7.89682 -1.65231,8.39853 -5.607876,12.7424 -16.290776,17.89 -8.70033,4.19228 -15.33096,5.38601 -22.28257,4.01158 z M 41.277894,61.630701 c 1.24228,-1.242288 1.72377,-2.698296 1.3566,-4.102358 -0.32117,-1.228156 -0.0299,-2.509885 0.66851,-2.941512 2.68379,-1.658672 -4.40064,-10.83921 -7.45881,-9.665682 -1.9067,0.731671 -4.49209,6.575081 -4.49209,10.15288 0,1.419979 0.68655,3.909432 1.52568,5.532119 1.81367,3.507245 5.4713,3.953363 8.40011,1.024553 z M 194.16354,36.517533 c 2.75029,-2.562289 2.79031,-5.92633 0.11101,-9.332507 -3.05034,-3.877877 -5.47694,-4.92862 -8.17245,-3.538759 -3.60884,1.860794 -6.64509,5.020036 -6.12562,6.373754 0.27197,0.708744 -0.84255,1.79841 -2.57223,2.514868 -3.56041,1.474768 -4.06667,2.936992 -0.80215,2.316805 1.2375,-0.235098 4.275,0.492422 6.75,1.61671 5.70295,2.590608 8.07193,2.601373 10.81144,0.04913 z M 151.68006,297.61831 c -5.1095,-2.31988 -7.07949,-5.19723 -9.47638,-13.84118 -2.20166,-7.93986 -2.22094,-8.22065 -0.56457,-8.22065 0.70785,0 2.96667,2.92041 5.0196,6.48979 4.51601,7.85189 7.50211,10.01021 13.84941,10.01021 7.21444,0 7.55209,-1.03584 3.20284,-9.82553 -2.06943,-4.18224 -3.40017,-7.95741 -2.9572,-8.38927 0.44297,-0.43186 2.44631,1.21347 4.45187,3.65629 2.00556,2.44281 4.65435,5.59281 5.8862,7 l 2.23974,2.55851 4.13763,-4.34782 4.13764,-4.34783 -0.62307,-6.65217 c -0.34268,-3.6587 -0.7375,-7.77718 -0.87737,-9.15218 -0.1944,-1.91117 0.26333,-2.57365 1.94339,-2.8127 5.20987,-0.74128 8.73933,15.19935 4.97646,22.47593 -2.42423,4.68794 -9.63733,11.13207 -16.08387,14.3692 -6.99762,3.51386 -13.07501,3.83864 -19.26232,1.0294 z m -16.41415,-63.45448 c -7.07389,-3.76411 -9.04133,-5.87983 -7.18966,-7.7315 0.90559,-0.90559 2.59784,-0.56394 7.29344,1.47248 7.75082,3.36143 9.14596,3.32498 13.32963,-0.34833 3.37017,-2.95905 6.65278,-3.94703 6.65278,-2.00231 0,0.54872 -1.58553,3.20462 -3.52339,5.90198 -5.29715,7.37325 -7.20779,7.6856 -16.5628,2.70768 z m -7.50882,-71.71234 c -1.61352,-1.78292 -1.90499,-3.67938 -1.90499,-12.39501 0,-8.71563 0.29147,-10.61209 1.90499,-12.39501 2.55654,-2.82496 5.02002,-2.65143 7.52243,0.52987 1.74538,2.21888 2.07258,4.0448 2.07258,11.56574 0,10.75932 -1.64166,14.74133 -6.09501,14.78409 -0.87726,0.008 -2.45226,-0.93193 -3.5,-2.08968 z m 43.58151,-5.6393 c -1.93776,-2.46347 -2.12426,-3.73206 -1.82258,-12.3974 0.27076,-7.77678 0.70636,-10.06181 2.24107,-11.75571 2.55728,-2.82256 5.02063,-2.64826 7.52243,0.53226 1.75677,2.23337 2.07258,4.04131 2.07258,11.86514 0,7.82383 -0.31581,9.63177 -2.07258,11.86514 -2.65688,3.37768 -5.22581,3.34228 -7.94092,-0.10943 z"
			id="path3422" />
		</svg>

		<div style="font-size:80px; padding-top:10px; font-family: Georgia, serif;" ng-cloak>{{(just_authed()) ? ((is_loading) ? '...' : '&#9825;') : 'hi'}}</div>
		<div id="discussion" style="padding: 1em">
		    <div ng-hide="just_authed()" style="text-align:center">
			<div style="font-size: 115%">
			  I make <span ng-cloak>{{opts.service}}</span>
			  <span class="callout" ng-cloak>
			    use 
			    <a href="#" ng-click="opts.service=(opts.service==='rdio')?'spotify':'rdio'; save_options(); get_music()">{{(opts.service==='rdio') ? 'spotify' : 'rdio'}}</a>?
			  </span>
			  playlists of artists playing near you, tonight.
			</div>
			&nbsp;
			<div ng-show="track_data && !is_loading" class="bouncy" style="margin-top:5px" ng-cloak>
			  <a href="#" style="display:inline-block" class="outlined big" ng-click="$event.preventDefault(); showOptions = true">
			    <svg xmlns="http://www.w3.org/2000/svg" version="1.1"  width="16" height="16" viewBox="0 0 128 128">
			      <g data-width="128" data-height="128" class="iconic-lg iconic-container" display="inline" transform="rotate(180 64 64) translate(24)">
				<path d="M78.8 63.1l-77.6-62.2c-.7-.5-1.2-.2-1.2.6v125c0 .8.5 1.1 1.2.6l77.7-62.1c.6-.6.6-1.4-.1-1.9z"></path>
			      </g>
			    </svg>
			    options
			  </a>
			  <a href="#" style="display:inline-block" class="outlined big" ng-click="$event.preventDefault(); make_playlist()">
			    <!-- rdio -->
			    <svg ng-show="opts.service==='rdio'" class="serviceicon" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 445 445">  <!-- 445x445 -->
			      <path style="fill:#008fd5;fill-opacity:1"
				    d="M 162.89738,364.01324 C 99.852746,355.3475 46.425374,317.48711 19.564299,262.44268 5.7603533,234.15528 0.80023898,210.23136 1.9554289,177.51056 3.0051448,147.77729 8.4209371,126.88309 21.773028,101.05399 43.226859,59.552392 81.836011,26.710177 126.84653,11.675001 161.26037,0.1795098 200.0519,-1.8530841 234.88781,6.0138663 l 8.93781,2.0184118 0,52.4809269 c 0,49.484855 -0.12945,52.425965 -2.26778,51.517765 -15.36862,-6.52742 -40.97087,-8.80111 -58.70538,-5.2135 -44.60639,9.0236 -80.12253,45.91664 -82.51653,85.71549 -1.239746,20.61014 4.31068,35.06722 18.59232,48.42699 15.41579,14.42071 32.13432,20.06201 59.45573,20.06201 21.37979,0 29.14676,-1.72748 46.84559,-10.41911 24.61685,-12.08897 42.71938,-32.20057 52.63893,-58.48092 2.77399,-7.34927 2.83243,-8.937 3.24471,-88.15222 0.23092,-44.367483 0.87119,-80.668159 1.42282,-80.668159 0.55165,0 11.74855,6.491655 24.88203,14.425897 49.04034,29.626413 89.09493,45.184303 116.32927,45.184303 9.6137,0 13.65008,1.447761 16.60354,5.955329 3.45378,5.271128 2.53417,12.68038 -2.95141,23.77971 -8.69591,17.595 -29.69896,35.39773 -50.51152,42.81487 l -7.90697,2.81788 0.57821,18.36267 c 2.8261,89.7483 -58.34919,165.48894 -149.34024,184.89697 -14.92661,3.18379 -52.19419,4.55336 -67.32155,2.47405 z"
				    id="path3451" />
			    </svg>
			    <!-- spotify -->
			    <svg ng-show="opts.service==='spotify'" class="serviceicon" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 480 480"> <!-- 480x480-->
			      <path style="fill:#aed000;fill-opacity:1"
				    d="m 224.59171,475.94895 c -16.5006,-1.66121 -24.95883,-2.82054 -33.46868,-4.58738 C 96.070853,451.62658 22.783622,375.92435 5.7359591,279.86552 2.5039287,261.65391 1.7509347,227.85064 4.1563194,208.95241 10.688265,157.63319 33.437416,110.50665 69.526677,73.532914 89.892963,52.667478 108.73146,38.934999 134.65748,26.055242 190.3825,-1.6283098 257.25255,-5.9491662 316.60309,14.298683 c 15.2482,5.20204 39.89684,17.331758 53.19124,26.175686 92.37272,61.449751 130.6625,177.162431 92.69443,280.124961 -21.34855,57.8934 -63.494,104.37436 -119.46938,131.75925 -23.13085,11.31633 -44.42202,17.91264 -69.65823,21.58113 -10.8419,1.57606 -40.80901,2.81065 -48.76944,2.00924 z M 340.44487,348.00672 c 0,-0.47069 1.19806,-1.49698 2.66237,-2.28065 3.71521,-1.98831 5.57607,-6.13851 5.57607,-12.43603 0,-4.98632 -0.31973,-5.68305 -4.40355,-9.59605 -8.27763,-7.93136 -40.48571,-22.11623 -64.07853,-28.22103 -23.8062,-6.16 -34.70456,-7.5536 -63.58573,-8.13079 -29.08924,-0.58135 -43.54046,0.36725 -67.71451,4.44492 -23.84347,4.02191 -31.00184,5.99021 -33.58995,9.236 -4.18722,5.25129 -3.82823,14.76763 0.74054,19.63087 4.17807,4.44735 8.34304,4.79723 23.14864,1.9446 29.70943,-5.72418 42.76477,-7.08605 68.3997,-7.13519 18.15731,-0.0348 27.15771,0.40737 36.0432,1.77079 14.43356,2.21473 34.35061,7.04665 46.25171,11.22078 9.1447,3.20735 33.66164,15.03016 38.19237,18.41751 2.61916,1.9582 12.35767,2.85206 12.35767,1.13427 z m 28.58652,-61.9568 c 5.26719,-3.21144 7.44835,-7.69829 7.45282,-15.3311 0.005,-9.48678 -2.02437,-12.20862 -14.28071,-19.14822 -32.27619,-18.27494 -71.51483,-30.59713 -115.2001,-36.17653 -15.63784,-1.99724 -58.77284,-2.26346 -75.44668,-0.46563 -25.40167,2.73888 -54.81422,9.04467 -61.09684,13.0986 -7.4203,4.78805 -9.82406,14.68312 -5.58308,22.98289 5.00443,9.7939 11.91457,11.20086 31.15162,6.34268 27.50676,-6.94664 47.07247,-8.96994 77.75033,-8.04019 52.28734,1.58466 89.32932,11.46412 135.3154,36.08994 6.40843,3.43177 14.91751,3.70813 19.93724,0.64756 z m 30.37483,-70.00397 c 5.74827,-3.93878 10.03674,-11.29973 10.02989,-17.2158 -0.0163,-14.02126 -6.73291,-20.24486 -35.97781,-33.33673 -58.36264,-26.12679 -146.95977,-37.00649 -221.46789,-27.19619 -16.10108,2.11998 -36.82209,6.29274 -46.62299,9.38885 -13.365887,4.22228 -18.254779,10.36011 -18.254779,22.91828 0,5.52186 1.345008,8.56922 6.108951,13.84098 5.960658,6.59606 14.791998,8.46044 25.166738,5.31294 7.06735,-2.14408 27.72669,-6.42887 39.56355,-8.20556 27.04313,-4.05912 66.65556,-4.49117 96.9968,-1.05792 44.41314,5.02555 79.2885,14.55886 110.21153,30.12675 16.78143,8.44844 17.07607,8.55042 23.79817,8.23696 5.1602,-0.24063 7.6871,-0.92087 10.44784,-2.81256 z"
				id="path4497" />
			    </svg>
			    
			    make playlist
			  </a>
			</div>
		    </div>
		    <div ng-show="just_authed()" ng-cloak>
			<div ng-show="is_loading">
			    Creating Playlist...
			</div>
			<div ng-hide="is_loading" style="text-align:left" class="bouncy">
			    <a ng-href="{{playlist_links.http}}" style="display:inline-block" class="outlined big" ng-click="open_playlist($event)">Open playlist in {{opts.service}}</a>
			</div>
		    </div>
		</div>
	    </div>
	    <div class="results" ng-cloak>
		<div ng-show="is_loading">
		  <div><img src="img/loading.svg" width="128" height="64" alt="loading..." /></div>
		  <div ng-show="load_error">{{load_error}}</div>
		</div>
		<ul ng-show="track_data">
		    <li ng-repeat="track in track_data">
		      <a ng-href="{{get_ticket_link(track)}}" style="display:block; padding:0.4em 1em" ng-click="buy_tickets(track, $event)">
			{{track.name}}<br/>
			{{track.artist}} &nbsp; @ {{track.event.venue.name}}
			&nbsp;<span class="event_date">{{(opts.daysout > 1) ? '('+track.event.datestring+')' : ''}}</span>
		      </a>
		    </li>
		</ul>
	    </div>
	    <div style="padding:6em 1em 1em 1em">&nbsp;</div>
	    <div ng-hide="is_app" style="display:block; width:286px; margin: 1em auto" >

	      <a href="https://itunes.apple.com/us/app/music-tonight/id975200010?ls=1&mt=8">

		<svg version="1.1" width="148" height="44" style="display:inline-block" id="US_UK_Download_on_the" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
	 x="0px" y="0px" width="135px" height="40px" viewBox="0 0 135 40" enable-background="new 0 0 135 40" xml:space="preserve">
<g>
	<path fill="#A6A6A6" d="M130.197,40H4.729C2.122,40,0,37.872,0,35.267V4.726C0,2.12,2.122,0,4.729,0h125.468
		C132.803,0,135,2.12,135,4.726v30.541C135,37.872,132.803,40,130.197,40L130.197,40z"/>
	<path d="M134.032,35.268c0,2.116-1.714,3.83-3.834,3.83H4.729c-2.119,0-3.839-1.714-3.839-3.83V4.725
		c0-2.115,1.72-3.835,3.839-3.835h125.468c2.121,0,3.834,1.72,3.834,3.835L134.032,35.268L134.032,35.268z"/>
	<g>
		<g>
			<path fill="#FFFFFF" d="M30.128,19.784c-0.029-3.223,2.639-4.791,2.761-4.864c-1.511-2.203-3.853-2.504-4.676-2.528
				c-1.967-0.207-3.875,1.177-4.877,1.177c-1.022,0-2.565-1.157-4.228-1.123c-2.14,0.033-4.142,1.272-5.24,3.196
				c-2.266,3.923-0.576,9.688,1.595,12.859c1.086,1.553,2.355,3.287,4.016,3.226c1.625-0.067,2.232-1.036,4.193-1.036
				c1.943,0,2.513,1.036,4.207,0.997c1.744-0.028,2.842-1.56,3.89-3.127c1.255-1.78,1.759-3.533,1.779-3.623
				C33.507,24.924,30.161,23.647,30.128,19.784z"/>
			<path fill="#FFFFFF" d="M26.928,10.306c0.874-1.093,1.472-2.58,1.306-4.089c-1.265,0.056-2.847,0.875-3.758,1.944
				c-0.806,0.942-1.526,2.486-1.34,3.938C24.557,12.205,26.016,11.382,26.928,10.306z"/>
		</g>
	</g>
	<g>
		<path fill="#FFFFFF" d="M53.645,31.504h-2.271l-1.244-3.909h-4.324l-1.185,3.909h-2.211l4.284-13.308h2.646L53.645,31.504z
			 M49.755,25.955L48.63,22.48c-0.119-0.355-0.342-1.191-0.671-2.507h-0.04c-0.131,0.566-0.342,1.402-0.632,2.507l-1.105,3.475
			H49.755z"/>
		<path fill="#FFFFFF" d="M64.662,26.588c0,1.632-0.441,2.922-1.323,3.869c-0.79,0.843-1.771,1.264-2.942,1.264
			c-1.264,0-2.172-0.454-2.725-1.362h-0.04v5.055h-2.132V25.067c0-1.026-0.027-2.079-0.079-3.159h1.875l0.119,1.521h0.04
			c0.711-1.146,1.79-1.718,3.238-1.718c1.132,0,2.077,0.447,2.833,1.342C64.284,23.949,64.662,25.127,64.662,26.588z M62.49,26.666
			c0-0.934-0.21-1.704-0.632-2.31c-0.461-0.632-1.08-0.948-1.856-0.948c-0.526,0-1.004,0.176-1.431,0.523
			c-0.428,0.35-0.708,0.807-0.839,1.373c-0.066,0.264-0.099,0.48-0.099,0.65v1.6c0,0.698,0.214,1.287,0.642,1.768
			s0.984,0.721,1.668,0.721c0.803,0,1.428-0.31,1.875-0.928C62.266,28.496,62.49,27.68,62.49,26.666z"/>
		<path fill="#FFFFFF" d="M75.699,26.588c0,1.632-0.441,2.922-1.324,3.869c-0.789,0.843-1.77,1.264-2.941,1.264
			c-1.264,0-2.172-0.454-2.724-1.362H68.67v5.055h-2.132V25.067c0-1.026-0.027-2.079-0.079-3.159h1.875l0.119,1.521h0.04
			c0.71-1.146,1.789-1.718,3.238-1.718c1.131,0,2.076,0.447,2.834,1.342C75.32,23.949,75.699,25.127,75.699,26.588z M73.527,26.666
			c0-0.934-0.211-1.704-0.633-2.31c-0.461-0.632-1.078-0.948-1.855-0.948c-0.527,0-1.004,0.176-1.432,0.523
			c-0.428,0.35-0.707,0.807-0.838,1.373c-0.065,0.264-0.099,0.48-0.099,0.65v1.6c0,0.698,0.214,1.287,0.64,1.768
			c0.428,0.48,0.984,0.721,1.67,0.721c0.803,0,1.428-0.31,1.875-0.928C73.303,28.496,73.527,27.68,73.527,26.666z"/>
		<path fill="#FFFFFF" d="M88.039,27.772c0,1.132-0.393,2.053-1.182,2.764c-0.867,0.777-2.074,1.165-3.625,1.165
			c-1.432,0-2.58-0.276-3.449-0.829l0.494-1.777c0.936,0.566,1.963,0.85,3.082,0.85c0.803,0,1.428-0.182,1.877-0.544
			c0.447-0.362,0.67-0.848,0.67-1.454c0-0.54-0.184-0.995-0.553-1.364c-0.367-0.369-0.98-0.712-1.836-1.029
			c-2.33-0.869-3.494-2.142-3.494-3.816c0-1.094,0.408-1.991,1.225-2.689c0.814-0.699,1.9-1.048,3.258-1.048
			c1.211,0,2.217,0.211,3.02,0.632l-0.533,1.738c-0.75-0.408-1.598-0.612-2.547-0.612c-0.75,0-1.336,0.185-1.756,0.553
			c-0.355,0.329-0.533,0.73-0.533,1.205c0,0.526,0.203,0.961,0.611,1.303c0.355,0.316,1,0.658,1.936,1.027
			c1.145,0.461,1.986,1,2.527,1.618C87.77,26.081,88.039,26.852,88.039,27.772z"/>
		<path fill="#FFFFFF" d="M95.088,23.508h-2.35v4.659c0,1.185,0.414,1.777,1.244,1.777c0.381,0,0.697-0.033,0.947-0.099l0.059,1.619
			c-0.42,0.157-0.973,0.236-1.658,0.236c-0.842,0-1.5-0.257-1.975-0.77c-0.473-0.514-0.711-1.376-0.711-2.587v-4.837h-1.4v-1.6h1.4
			v-1.757l2.094-0.632v2.389h2.35V23.508z"/>
		<path fill="#FFFFFF" d="M105.691,26.627c0,1.475-0.422,2.686-1.264,3.633c-0.883,0.975-2.055,1.461-3.516,1.461
			c-1.408,0-2.529-0.467-3.365-1.401s-1.254-2.113-1.254-3.534c0-1.487,0.43-2.705,1.293-3.652c0.861-0.948,2.023-1.422,3.484-1.422
			c1.408,0,2.541,0.467,3.396,1.402C105.283,24.021,105.691,25.192,105.691,26.627z M103.479,26.696
			c0-0.885-0.189-1.644-0.572-2.277c-0.447-0.766-1.086-1.148-1.914-1.148c-0.857,0-1.508,0.383-1.955,1.148
			c-0.383,0.634-0.572,1.405-0.572,2.317c0,0.885,0.189,1.644,0.572,2.276c0.461,0.766,1.105,1.148,1.936,1.148
			c0.814,0,1.453-0.39,1.914-1.168C103.281,28.347,103.479,27.58,103.479,26.696z"/>
		<path fill="#FFFFFF" d="M112.621,23.783c-0.211-0.039-0.436-0.059-0.672-0.059c-0.75,0-1.33,0.283-1.738,0.85
			c-0.355,0.5-0.533,1.132-0.533,1.895v5.035h-2.131l0.02-6.574c0-1.106-0.027-2.113-0.08-3.021h1.857l0.078,1.836h0.059
			c0.225-0.631,0.58-1.139,1.066-1.52c0.475-0.343,0.988-0.514,1.541-0.514c0.197,0,0.375,0.014,0.533,0.039V23.783z"/>
		<path fill="#FFFFFF" d="M122.156,26.252c0,0.382-0.025,0.704-0.078,0.967h-6.396c0.025,0.948,0.334,1.673,0.928,2.173
			c0.539,0.447,1.236,0.671,2.092,0.671c0.947,0,1.811-0.151,2.588-0.454l0.334,1.48c-0.908,0.396-1.98,0.593-3.217,0.593
			c-1.488,0-2.656-0.438-3.506-1.313c-0.848-0.875-1.273-2.05-1.273-3.524c0-1.447,0.395-2.652,1.186-3.613
			c0.828-1.026,1.947-1.539,3.355-1.539c1.383,0,2.43,0.513,3.141,1.539C121.873,24.047,122.156,25.055,122.156,26.252z
			 M120.123,25.699c0.014-0.632-0.125-1.178-0.414-1.639c-0.369-0.593-0.936-0.889-1.699-0.889c-0.697,0-1.264,0.289-1.697,0.869
			c-0.355,0.461-0.566,1.014-0.631,1.658H120.123z"/>
	</g>
	<g>
		<g>
			<path fill="#FFFFFF" d="M49.05,10.009c0,1.177-0.353,2.063-1.058,2.658c-0.653,0.549-1.581,0.824-2.783,0.824
				c-0.596,0-1.106-0.026-1.533-0.078V6.982c0.557-0.09,1.157-0.136,1.805-0.136c1.145,0,2.008,0.249,2.59,0.747
				C48.723,8.156,49.05,8.961,49.05,10.009z M47.945,10.038c0-0.763-0.202-1.348-0.606-1.756c-0.404-0.407-0.994-0.611-1.771-0.611
				c-0.33,0-0.611,0.022-0.844,0.068v4.889c0.129,0.02,0.365,0.029,0.708,0.029c0.802,0,1.421-0.223,1.857-0.669
				S47.945,10.892,47.945,10.038z"/>
			<path fill="#FFFFFF" d="M54.909,11.037c0,0.725-0.207,1.319-0.621,1.785c-0.434,0.479-1.009,0.718-1.727,0.718
				c-0.692,0-1.243-0.229-1.654-0.689c-0.41-0.459-0.615-1.038-0.615-1.736c0-0.73,0.211-1.329,0.635-1.794s0.994-0.698,1.712-0.698
				c0.692,0,1.248,0.229,1.669,0.688C54.708,9.757,54.909,10.333,54.909,11.037z M53.822,11.071c0-0.435-0.094-0.808-0.281-1.119
				c-0.22-0.376-0.533-0.564-0.94-0.564c-0.421,0-0.741,0.188-0.961,0.564c-0.188,0.311-0.281,0.69-0.281,1.138
				c0,0.435,0.094,0.808,0.281,1.119c0.227,0.376,0.543,0.564,0.951,0.564c0.4,0,0.714-0.191,0.94-0.574
				C53.725,11.882,53.822,11.506,53.822,11.071z"/>
			<path fill="#FFFFFF" d="M62.765,8.719l-1.475,4.714h-0.96l-0.611-2.047c-0.155-0.511-0.281-1.019-0.379-1.523h-0.019
				c-0.091,0.518-0.217,1.025-0.379,1.523l-0.649,2.047h-0.971l-1.387-4.714h1.077l0.533,2.241c0.129,0.53,0.235,1.035,0.32,1.513
				h0.019c0.078-0.394,0.207-0.896,0.389-1.503l0.669-2.25h0.854l0.641,2.202c0.155,0.537,0.281,1.054,0.378,1.552h0.029
				c0.071-0.485,0.178-1.002,0.32-1.552l0.572-2.202H62.765z"/>
			<path fill="#FFFFFF" d="M68.198,13.433H67.15v-2.7c0-0.832-0.316-1.248-0.95-1.248c-0.311,0-0.562,0.114-0.757,0.343
				c-0.193,0.229-0.291,0.499-0.291,0.808v2.796h-1.048v-3.366c0-0.414-0.013-0.863-0.038-1.349h0.921l0.049,0.737h0.029
				c0.122-0.229,0.304-0.418,0.543-0.569c0.284-0.176,0.602-0.265,0.95-0.265c0.44,0,0.806,0.142,1.097,0.427
				c0.362,0.349,0.543,0.87,0.543,1.562V13.433z"/>
			<path fill="#FFFFFF" d="M71.088,13.433h-1.047V6.556h1.047V13.433z"/>
			<path fill="#FFFFFF" d="M77.258,11.037c0,0.725-0.207,1.319-0.621,1.785c-0.434,0.479-1.01,0.718-1.727,0.718
				c-0.693,0-1.244-0.229-1.654-0.689c-0.41-0.459-0.615-1.038-0.615-1.736c0-0.73,0.211-1.329,0.635-1.794s0.994-0.698,1.711-0.698
				c0.693,0,1.248,0.229,1.67,0.688C77.057,9.757,77.258,10.333,77.258,11.037z M76.17,11.071c0-0.435-0.094-0.808-0.281-1.119
				c-0.219-0.376-0.533-0.564-0.939-0.564c-0.422,0-0.742,0.188-0.961,0.564c-0.188,0.311-0.281,0.69-0.281,1.138
				c0,0.435,0.094,0.808,0.281,1.119c0.227,0.376,0.543,0.564,0.951,0.564c0.4,0,0.713-0.191,0.939-0.574
				C76.074,11.882,76.17,11.506,76.17,11.071z"/>
			<path fill="#FFFFFF" d="M82.33,13.433h-0.941l-0.078-0.543h-0.029c-0.322,0.433-0.781,0.65-1.377,0.65
				c-0.445,0-0.805-0.143-1.076-0.427c-0.246-0.258-0.369-0.579-0.369-0.96c0-0.576,0.24-1.015,0.723-1.319
				c0.482-0.304,1.16-0.453,2.033-0.446V10.3c0-0.621-0.326-0.931-0.979-0.931c-0.465,0-0.875,0.117-1.229,0.349l-0.213-0.688
				c0.438-0.271,0.979-0.407,1.617-0.407c1.232,0,1.85,0.65,1.85,1.95v1.736C82.262,12.78,82.285,13.155,82.33,13.433z
				 M81.242,11.813v-0.727c-1.156-0.02-1.734,0.297-1.734,0.95c0,0.246,0.066,0.43,0.201,0.553c0.135,0.123,0.307,0.184,0.512,0.184
				c0.23,0,0.445-0.073,0.641-0.218c0.197-0.146,0.318-0.331,0.363-0.558C81.236,11.946,81.242,11.884,81.242,11.813z"/>
			<path fill="#FFFFFF" d="M88.285,13.433h-0.93l-0.049-0.757h-0.029c-0.297,0.576-0.803,0.864-1.514,0.864
				c-0.568,0-1.041-0.223-1.416-0.669s-0.562-1.025-0.562-1.736c0-0.763,0.203-1.381,0.611-1.853c0.395-0.44,0.879-0.66,1.455-0.66
				c0.633,0,1.076,0.213,1.328,0.64h0.02V6.556h1.049v5.607C88.248,12.622,88.26,13.045,88.285,13.433z M87.199,11.445v-0.786
				c0-0.136-0.01-0.246-0.029-0.33c-0.059-0.252-0.186-0.464-0.379-0.635c-0.195-0.171-0.43-0.257-0.701-0.257
				c-0.391,0-0.697,0.155-0.922,0.466c-0.223,0.311-0.336,0.708-0.336,1.193c0,0.466,0.107,0.844,0.322,1.135
				c0.227,0.31,0.533,0.465,0.916,0.465c0.344,0,0.619-0.129,0.828-0.388C87.1,12.069,87.199,11.781,87.199,11.445z"/>
			<path fill="#FFFFFF" d="M97.248,11.037c0,0.725-0.207,1.319-0.621,1.785c-0.434,0.479-1.008,0.718-1.727,0.718
				c-0.691,0-1.242-0.229-1.654-0.689c-0.41-0.459-0.615-1.038-0.615-1.736c0-0.73,0.211-1.329,0.635-1.794s0.994-0.698,1.713-0.698
				c0.691,0,1.248,0.229,1.668,0.688C97.047,9.757,97.248,10.333,97.248,11.037z M96.162,11.071c0-0.435-0.094-0.808-0.281-1.119
				c-0.221-0.376-0.533-0.564-0.941-0.564c-0.42,0-0.74,0.188-0.961,0.564c-0.188,0.311-0.281,0.69-0.281,1.138
				c0,0.435,0.094,0.808,0.281,1.119c0.227,0.376,0.543,0.564,0.951,0.564c0.4,0,0.715-0.191,0.941-0.574
				C96.064,11.882,96.162,11.506,96.162,11.071z"/>
			<path fill="#FFFFFF" d="M102.883,13.433h-1.047v-2.7c0-0.832-0.316-1.248-0.951-1.248c-0.311,0-0.562,0.114-0.756,0.343
				s-0.291,0.499-0.291,0.808v2.796h-1.049v-3.366c0-0.414-0.012-0.863-0.037-1.349h0.92l0.049,0.737h0.029
				c0.123-0.229,0.305-0.418,0.543-0.569c0.285-0.176,0.602-0.265,0.951-0.265c0.439,0,0.805,0.142,1.096,0.427
				c0.363,0.349,0.543,0.87,0.543,1.562V13.433z"/>
			<path fill="#FFFFFF" d="M109.936,9.504h-1.154v2.29c0,0.582,0.205,0.873,0.611,0.873c0.188,0,0.344-0.016,0.467-0.049
				l0.027,0.795c-0.207,0.078-0.479,0.117-0.814,0.117c-0.414,0-0.736-0.126-0.969-0.378c-0.234-0.252-0.35-0.676-0.35-1.271V9.504
				h-0.689V8.719h0.689V7.855l1.027-0.31v1.173h1.154V9.504z"/>
			<path fill="#FFFFFF" d="M115.484,13.433h-1.049v-2.68c0-0.845-0.316-1.268-0.949-1.268c-0.486,0-0.818,0.245-1,0.735
				c-0.031,0.103-0.049,0.229-0.049,0.377v2.835h-1.047V6.556h1.047v2.841h0.02c0.33-0.517,0.803-0.775,1.416-0.775
				c0.434,0,0.793,0.142,1.078,0.427c0.355,0.355,0.533,0.883,0.533,1.581V13.433z"/>
			<path fill="#FFFFFF" d="M121.207,10.853c0,0.188-0.014,0.346-0.039,0.475h-3.143c0.014,0.466,0.164,0.821,0.455,1.067
				c0.266,0.22,0.609,0.33,1.029,0.33c0.465,0,0.889-0.074,1.271-0.223l0.164,0.728c-0.447,0.194-0.973,0.291-1.582,0.291
				c-0.73,0-1.305-0.215-1.721-0.645c-0.418-0.43-0.625-1.007-0.625-1.731c0-0.711,0.193-1.303,0.582-1.775
				c0.406-0.504,0.955-0.756,1.648-0.756c0.678,0,1.193,0.252,1.541,0.756C121.068,9.77,121.207,10.265,121.207,10.853z
				 M120.207,10.582c0.008-0.311-0.061-0.579-0.203-0.805c-0.182-0.291-0.459-0.437-0.834-0.437c-0.342,0-0.621,0.142-0.834,0.427
				c-0.174,0.227-0.277,0.498-0.311,0.815H120.207z"/>
		</g>
	</g>
</g>
</svg>
	      </a>
	      <a href="https://play.google.com/store/apps/details?id=com.millstonecw.musictonight">
		<img alt="Get it on Google Play" width="129" height="45" src="img/GooglePlayBadge_45.png"  style="display:inline-block"/>
	      </a>
	    </div>
	    <div style="padding:1em; text-align:center; font-size:80%">
		<div>
		    <span>
			I'm new at this.  Chat with me! - musictonight@millstonecw.com
		    </span>
		</div>
		<div style="padding-top:0.6em">
		  powered by: <a href="http://www.spotify.com"><img height="33" width="110" src="img/spotify-logo-primary-horizontal-light-background-rgb2.png" style="position:relative; top:9px"/></a>
		    <a href="http://bandsintown.com"><img height="33" width="135" src="img/bandsintown135x33.png" style="position:relative; top:9px;"/></a>
		</div>
	    </div>
	</div>
	<script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=GOOGLE_API_KEY" inline></script>
	<script>
	 (function() {
	   var OPTS_DEFAULTS = {daysout:1, maxmiles:125, loctext:'', maxartisttracks:2, service:'spotify'};
	   var client_id = 'SPOTIFY_CLIENT_ID';
	   
	   var g_tracks = [];
	   var g_name = format_date(new Date()) + '-music-tonight';
	   var is_app = (window.location.search !== undefined) ? (window.location.search.indexOf('?mobileapp=1') == 0) : false;
	   var base = (window.location + "").replace(/(\/[^\/]*)$/, '');
	   var server = (is_app) ? 'APP_SERVER_URL' : base;
	   var get_playlist_uri = server + '/api/playlist';
	   var platform = 'web';

	   if (is_app) {
	     platform = (navigator.userAgent.match(/iPad/i))  == "iPad" ? "ios" : (navigator.userAgent.match(/iPhone/i))  == "iPhone" ? "ios" : (navigator.userAgent.match(/Android/i)) == "Android" ? "android" : "unknown_app";
	   }
	   
	   function format_date(dt) {
	     var yyyy = dt.getFullYear().toString();
	     var mm = (dt.getMonth()+1).toString(); // getMonth() is zero-based
	     var dd  = dt.getDate().toString();
	     return yyyy + '-' + (mm[1]?mm:"0"+mm[0]) + '-' + (dd[1]?dd:"0"+dd[0]); // padding
	   }

	   function fallback_goto(url, fallback) {
	     try {
	       window.location = url;
	     } catch(e) {
	       window.locaiton = fallback;
	     }
	     return;
	     var script = document.createElement('script'); 
	     script.onload = function() { 
               window.location = url;
	     } 
	     script.onerror = function() { 
               window.location = fallback;
	     } 
	     script.setAttribute('src', url); 
	     document.getElementsByTagName('head')[0].appendChild(script);
	   }

	   function parse_hash_query(url) {
	     var args = {};
	     var hash = url.replace(/^[^\#]*#/g, '');
	     if (! hash) return null;
	     var all = hash.split('&');
	     all.forEach(function(keyvalue) {
	       var idx = keyvalue.indexOf('=');
	       var key = keyvalue.substring(0, idx);
	       var val = decodeURIComponent(keyvalue.substring(idx + 1));
	       args[key] = val;
	     });
	     return args;
	   }
	   
	   if (is_app) {
	     document.write('<script type="text/javascript" src="cordova.js"><\/script>');
	   }
	   
	   var module = angular.module('musictonight', ['ngAnimate']);
	   
	   module.config(['$compileProvider', '$sceProvider', function($compileProvider, $sceProvider) {
	     $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|spotify):/);
	     $sceProvider.enabled(false);
	   }]);
	   
	   module.controller('mtController', [
	     '$scope', '$http', '$q', '$timeout',
	     function($scope, $http, $q, $timeout) {
	       console.log('controller init');
	       $scope.lang = navigator.languages ? navigator.languages[0] : (navigator.language || navigator.userLanguage);
	       $scope.playlist_links = parse_hash_query(window.location.hash);
	       $scope.is_app = is_app;
	       $scope.just_authed = function() { return $scope.playlist_links; }
	       $scope.opts = (localStorage.getItem('opts')) ? JSON.parse(localStorage.getItem('opts')) : {};
	       for (var k in OPTS_DEFAULTS) {
		 if ($scope.opts[k] === undefined) {
		   $scope.opts[k] = OPTS_DEFAULTS[k];
		 }
	       }

	       var citySearchInput = document.getElementById('citySearchInput');
	       citySearchInput.value = $scope.opts.loctext;
	       if (typeof google !== 'undefined') {
		 var cityAutocomplete = new google.maps.places.Autocomplete(
		   citySearchInput, { types: ['(regions)'] }
		 );
		 
		 $scope.place_to_scope = function() {
		   var place = cityAutocomplete.getPlace();
		   var loctext = citySearchInput.value;
		   if (! loctext) {
		     $scope.opts.latlon = null;
		     $scope.opts.loctext = '';
		   } else if (place) {
		     var loc = place.geometry.location;
		     $scope.opts.latlon = loc.k + ',' + loc.D;
		     $scope.opts.loctext = loctext;
		   }
		 };
		 
		 google.maps.event.addListener(cityAutocomplete, 'place_changed', $scope.place_to_scope);
	       }

	       $scope.reset_options = function() {
		 for (var k in OPTS_DEFAULTS) {
		   $scope.opts[k] = OPTS_DEFAULTS[k];
		 }
		 citySearchInput.value = '';
	       };

	       $scope.get_music = function(coords) {
		 console.log('getting music');
		 $scope.is_loading = true;
		 $scope.track_data = [];
		 ga('send', 'event', 'loading_playlist');
		 var uri = get_playlist_uri;
		 uri += '?daysout=' + $scope.opts.daysout;
		 uri += '&service=' + $scope.opts.service;
		 var maxmiles = $scope.opts.maxmiles;
		 if ($scope.lang != 'en-US') {
		   maxmiles = Math.round(maxmiles * 0.621371);
		 }
		 uri += '&maxmiles=' + maxmiles;
		 if ($scope.opts.latlon) {
		   uri += '&latlon=' + $scope.opts.latlon;
		 } else if (coords) {
		   uri += '&latlon=' + coords.latitude + ',' + coords.longitude;
		 }
		 uri += '&maxartisttracks=' + $scope.opts.maxartisttracks;
		 return $http.get(uri).then(
		   function(response) {
		     g_name = response.data.name;
		     $scope.track_data = response.data.tracks;
		     $scope.is_loading = false;
		     $scope.load_error = null;
		   },
		   function(error) {
		     if (JSON.stringify(error.data).indexOf('cannot_geo_ip') > -1) {
		       // try geolocation
		       console.log('geolocate');
		       navigator.geolocation.getCurrentPosition(
			 function(position) {
			   console.log('geolocate done');
			   $scope.get_music(position.coords);
			 },
			 function(err) {
			   console.log('geolocate err');
			   // give up and hope they enter it manually
			   // though this doesn't seem to ever get called for me
			   $scope.is_loading = false;
			 });
		     } else {
		       if (error.status >= 500 && error.status < 600) {
			 $scope.load_error = "Uh oh; I'm not feeling well. Maybe come back a little later?";
		       } else {
			 $scope.load_error = "Do you have a data connection?  I'll keep trying.";
		       }
		       $timeout(function(){$scope.get_music(coords);}, 5000);
		     }
		   }
		 );
	       };
	       
	       $scope.track_artist_json = function() {
		 if ($scope.track_data) {
		   var artists = $scope.track_data.map(function(track){ return track.key; });
		   return JSON.stringify(artists);
		 } else {
		   return '[]';
		 }
	       };
	       $scope.svc_auth_uri = server + '/api/music_svc_auth';
	       $scope.make_playlist = function() {
		 ga('send', 'event', 'start_auth');
		 var tracks = encodeURIComponent($scope.track_artist_json());
		 var url = $scope.svc_auth_uri + '?track_keys=' + tracks + '&service=' + $scope.opts.service;
		 if (is_app) {
		   console.log('opening', url);
		   var authWindow = window.open(url, '_blank', 'location=no,toolbar=no');
		   function loadstart_handler(e) {
		     var args = parse_hash_query(e.url);
		     var httplink = args.http;
		     var applink = args.app;
		     if (httplink) {
		       $scope.playlist_links = args;
		       authWindow.close();
		       $scope.$apply();
		     }
		   }
		   authWindow.addEventListener('loadstart', loadstart_handler);
		 } else {
		   window.location = url;
		 }
	       };
	       
	       $scope.get_ticket_link = function(track) {
		 if (is_app) {
		   var search = track.artist + ' at ' + track.event.venue.name;
		   return 'http://google.com/#q=' + encodeURIComponent(search);
		 } else {
		   return track.event.url;
		 }
	       };

	       $scope.buy_tickets = function(track, click_event) {
		 ga('send', 'event', 'goto_ticket');
		 if (is_app) {
		   var link = $scope.get_ticket_link(track);
		   click_event.preventDefault();
		   cordova.exec(null, null, "InAppBrowser", "open", [link, "_system"]);
		 }
	       };
	       
	       $scope.open_playlist = function(event) {
		 ga('send', 'event', 'opened_playlist');
		 if (is_app && (platform == 'ios' || platform == 'android')) {
		   var platform_map;
		   if ($scope.opts.service === 'spotify') {
		     platform_map = {'ios':['spotify://'], 'android':['com.spotify.music']};
		   } else {
		     platform_map = {'ios':['rdio://'], 'android':['com.rdio.oi.android.ui', 'com.rdio.android.ui']};
		   }
		   var schemes = platform_map[platform].slice(0);
		   console.log('m', platform_map, 'p', platform, schemes, $scope.playlist_links);
		   if (schemes) {
		     event.preventDefault();
		     function tryone() {
		       var scheme = schemes.pop();
		       appAvailability.check(
			 scheme,
			 function() {
			   cordova.exec(null, null, "InAppBrowser", "open", [$scope.playlist_links.app, "_system"]);
			   //window.location = $scope.playlist_links.app;
			 },
			 function() {
			   if (schemes) {
			     tryone();
			   } else {
			     cordova.exec(null, null, "InAppBrowser", "open", [$scope.playlist_links.http, "_system"]);
			   }
			 }
		       );
		     }
		     tryone();
		   }
		 }
	       };
	       
	       $scope.save_options = function() {
		 $scope.place_to_scope();
		 localStorage.setItem('opts', JSON.stringify($scope.opts));
	       }

	       $scope.load_initial = function() {
		 $scope.is_loading = true;
		 navigator.geolocation.getCurrentPosition(
		   function(position) {
		     $scope.get_music(position.coords);
		   },
		   function(err) { // try via IP
		     $scope.get_music();
		   });
	       };
	       
	       document.addEventListener('backbutton', function() {
		 console.log('pl links', $scope.playlist_links);
		 if ($scope.playlist_links) {
		   $scope.playlist_links = null;
		   $scope.load_initial();
		   $scope.$apply();
		 } else {
		   console.log('exiting app');
		   navigator.app.exitApp();
		 }
	       }, false);

	       if (! $scope.just_authed()) {
		 if (is_app) {
		   document.addEventListener("deviceready", $scope.load_initial);
		 } else {
		   $scope.get_music();
		 }
	       }
	       
	       console.log('controller init complete');
	     }]);
	   
	 })();

	</script>
    </body>
</html>
